<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babalu Motos Services</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="./style.css">
</head>

<body>
<div id="loginScreen" class="d-flex vh-100 justify-content-center align-items-center bg-dark">
  <div class="card p-4 shadow" style="width: 350px;">
    <h4 class="text-center mb-3">Babalu Motos</h4>

    <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
    <input type="password" id="loginSenha" class="form-control mb-3" placeholder="Senha">

    <button class="btn btn-primary w-100" id="btnLogin">Entrar</button>

    <small class="text-danger mt-2 d-none" id="loginErro"></small>
  </div>
</div>
<div id="app" class="d-none">
<nav class="navbar">
  <div class="container-fluid position-relative d-flex align-items-center">

    <!-- ESQUERDA -->
    <div class="d-flex align-items-center gap-2">
      <input class="form-control" type="search" placeholder="Digite o Nome/Placa" id="searchInput"/>
    </div>

    <!-- TEXTO ESQUERDO -->
    <div class="nav-text nav-text-left">BABALU</div>

    <!-- LOGO CENTRAL -->
    <div class="nav-logo">
      <img src="./img/logobaba.png" alt="Babalu Motos">
    </div>

    <!-- TEXTO DIREITO -->
    <div class="nav-text nav-text-right">MOTOS</div>

    <!-- DIREITA -->
    <div class="ms-auto">
      <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#novoServicoModal">
        <i class="bi bi-plus-circle"></i> Adicionar Novo
      </button>
    </div>

  </div>
</nav>

<div class="dropdown d-inline">
  <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btnAlertas">
    ‚ö† Troca de √ìleo <span class="badge bg-danger" id="contagemAlertas">0</span>
  </button>
  <ul class="dropdown-menu" id="listaAlertas" style="width: 350px; max-height: 400px; overflow-y:auto;">
    <!-- Alertas ser√£o inseridos aqui -->
  </ul>
</div>

<!-- Cards -->
  <div class="container">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 justify-content-center" id="cardsContainer">
      
      
    </div>
  </div>
<!-- Modal novo servi√ßo -->
<div class="modal fade" id="novoServicoModal">
<div class="modal-dialog">
<div class="modal-content">

<div class="modal-header">
<h5>Novo Servi√ßo</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<input class="form-control mb-2" placeholder="Nome da Moto" id="motoNome">
<input class="form-control mb-2" placeholder="Placa" id="placa">
<input class="form-control mb-2" placeholder="Cliente" id="clienteNome">
<input class="form-control mb-2" placeholder="Contato" id="clienteContato">

<select class="form-select mb-2" id="status">
<option value="andamento">Em andamento</option>
<option value="concluido">Servi√ßo conclu√≠do</option>
</select>

<input class="form-control" placeholder="URL imagem" id="imagem">
</div>

<div class="modal-footer">
<button class="btn btn-success" id="salvarServico">Salvar</button>
</div>

</div>
</div>
</div>

<!-- Modal detalhes -->
<div class="modal fade" id="detalhesModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="detalhesTitulo"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-4">

          <!-- BLOCO ESQUERDO: DADOS DA MOTO/CLIENTE -->
          <div class="col-md-5">
            <div class="card p-4 shadow-sm w-100" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Informa√ß√µes da Moto</h5>
              <p id="detalhesPlaca"></p>
              <p id="detalhesCliente"></p>
              <p id="detalhesContato"></p>

              <select class="form-select mt-3" id="detalhesStatusSelect">
                <option value="andamento">Em andamento</option>
                <option value="concluido">Servi√ßo conclu√≠do</option>
              </select>
              <!-- Bot√£o Troca de √ìleo -->
<button class="btn btn-outline-success w-100 mb-2" type="button" id="btnTrocaOleo">
  <i class="bi bi-droplet"></i> Troca de √ìleo
</button>

<!-- Formul√°rio de Troca de √ìleo (inicialmente escondido) -->
<div class="card p-3 mb-2 d-none" id="formTrocaOleo">
  <h6>Registrar Troca de √ìleo</h6>

  <input class="form-control mb-2" id="tipoOleo" placeholder="Tipo de √ìleo">
  <input type="number" class="form-control mb-2" id="kmAtual" placeholder="Quilometragem atual">
  <input type="number" class="form-control mb-2" id="kmProximaTroca" placeholder="Pr√≥xima troca (km)">
  <input type="number" class="form-control mb-2" id="mesesProximaTroca" placeholder="Pr√≥xima troca (meses)">

  <button class="btn btn-success w-100" id="salvarTrocaOleo">Salvar Troca</button>

  <small class="text-danger mt-2 d-block" id="alertaTrocaOleo"></small>
</div>
            </div>
          </div>

          <!-- BLOCO DIREITO: HIST√ìRICO E ANOTA√á√ïES -->
          <div class="col-md-7">
            <div class="card p-4 shadow-sm w-100 d-flex flex-column" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Hist√≥rico e Anota√ß√µes</h5>

              <!-- Hist√≥rico com scroll apenas nele -->
              <div class="accordion mb-3 flex-grow-1 overflow-auto" id="historicoAccordion" style="max-height: 60vh;"></div>

              <small id="ultimaAtualizacao" class="text-muted d-block mb-3"></small>

              <input class="form-control mb-2" id="tituloNota" placeholder="T√≠tulo da anota√ß√£o">
              <textarea class="form-control mb-2" id="textoNota" rows="3" placeholder="Descri√ß√£o do servi√ßo..."></textarea>

              <button class="btn btn-outline-primary w-100 mb-2" id="adicionarNota">
                <i class="bi bi-plus-lg"></i> Adicionar anota√ß√£o
              </button>


              <button class="btn btn-danger w-100 mt-auto" id="excluirMoto">
                <i class="bi bi-trash"></i> Excluir Moto
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>



<!-- Modal Galeria -->
<div class="modal fade" id="galeriaModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Galeria do Servi√ßo</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="file" class="form-control mb-3" id="uploadFotos" multiple accept="image/*">

        <div class="row g-3" id="galeriaContainer"></div>

      </div>
    </div>
  </div>
</div>
<!-- Modal Foto Tela Cheia -->
 <div class="modal fade" id="fotoModal">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">

      <div class="modal-body d-flex justify-content-center align-items-center">
        <img id="fotoGrande" class="img-fluid">
      </div>

      <button class="btn btn-light position-fixed top-0 end-0 m-3" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i>
      </button>

    </div>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDocs,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC48hyWdVdL1d54DMyys7qq2o7zp2tpxHc",
    authDomain: "babalu-motos.firebaseapp.com",
    projectId: "babalu-motos",
    storageBucket: "babalu-motos.appspot.com",
    messagingSenderId: "56196844709",
    appId: "1:56196844709:web:dba13125edd80228f1914c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // üîì exp√µe pro resto do c√≥digo
  window.auth = auth;
  window.db = db;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.signOut = signOut;
  window.onAuthStateChanged = onAuthStateChanged;
  window.collection = collection;
  window.doc = doc;
  window.setDoc = setDoc;
  window.getDocs = getDocs;
  window.deleteDoc = deleteDoc;
</script>


<script>
  // üîπ ELEMENTOS DE LOGIN / APP
  const loginScreen = document.getElementById("loginScreen");
  const appScreen = document.getElementById("app");
  const erroLogin = document.getElementById("loginErro");
  const cardsContainer = document.getElementById("cardsContainer");

  // üîπ LOGIN SIMPLIFICADO (apenas para mostrar app)
  document.getElementById("btnLogin").onclick = () => {
    const email = document.getElementById("loginEmail").value.trim();
    const senha = document.getElementById("loginSenha").value.trim();

    if (!email || !senha) {
      erroLogin.textContent = "Preencha email e senha!";
      erroLogin.classList.remove("d-none");
      return;
    }

    // login fict√≠cio: mostra app
    loginScreen.classList.add("d-none");
    appScreen.classList.remove("d-none");
  };

  // üîπ VARI√ÅVEIS GLOBAIS
  let motoSelecionada = null;

  const btnTrocaOleo = document.getElementById("btnTrocaOleo");
  const formTrocaOleo = document.getElementById("formTrocaOleo");
  const alertaTrocaOleo = document.getElementById("alertaTrocaOleo");
  const novoServicoModal = document.getElementById("novoServicoModal");
  const salvarServicoBtn = document.getElementById("salvarServico");

  const motoNome = document.getElementById("motoNome");
  const placa = document.getElementById("placa");
  const clienteNome = document.getElementById("clienteNome");
  const clienteContato = document.getElementById("clienteContato");
  const status = document.getElementById("status");
  const imagem = document.getElementById("imagem");

  // üîπ TOGGLE FORM TROCA DE √ìLEO
  if (btnTrocaOleo && formTrocaOleo) {
    btnTrocaOleo.onclick = () => formTrocaOleo.classList.toggle("d-none");
  }

  // üîπ SALVAR NOVO SERVI√áO
  salvarServicoBtn.onclick = () => {
    const nomeMotoVal = motoNome.value.trim();
    const placaVal = placa.value.trim();
    const clienteVal = clienteNome.value.trim();
    const contatoVal = clienteContato.value.trim();
    const statusVal = status.value;
    const imagemVal = imagem.value || "./img/default.jpg";

    if (!nomeMotoVal || !placaVal || !clienteVal) {
      return alert("Preencha todos os campos!");
    }

    const statusTexto = statusVal === "andamento" ? "Em andamento" : "Servi√ßo conclu√≠do";
    const statusCor = statusVal === "andamento" ? "text-danger" : "text-success";

    const col = document.createElement("div");
    col.className = "col";
    col.innerHTML = `
      <div class="card">
        <img src="${imagemVal}" class="card-img-top">
        <div class="card-body">
          <h5 class="card-title">${nomeMotoVal}</h5>
          <p class="card-text"><strong>Placa:</strong> ${placaVal}</p>
          <p class="fs-6 fw-bold ${statusCor}">${statusTexto}</p>
          <button class="btn btn-outline-warning">Detalhes</button>
          <button class="btn btn-outline-secondary">Galeria</button>
        </div>
      </div>
    `;

    const motoInfo = {
      nome: nomeMotoVal,
      placa: placaVal,
      clienteNome: clienteVal,
      clienteContato: contatoVal,
      statusTexto,
      statusCor,
      imagem: imagemVal,
      historico: [],
      galeria: [],
      contador: 0
    };

    motoInfo.card = col;
    col.motoInfo = motoInfo;

    adicionarEventoDetalhes(col, motoInfo);
    cardsContainer.appendChild(col);

    bootstrap.Modal.getInstance(novoServicoModal).hide();
  };

  // üîπ LIMPAR MODAL AO ABRIR
  novoServicoModal.addEventListener("show.bs.modal", () => {
    motoNome.value = "";
    placa.value = "";
    clienteNome.value = "";
    clienteContato.value = "";
    imagem.value = "";
    status.value = "andamento";
  });
 adicionarNota.onclick = () => {

      const titulo = tituloNota.value.trim();
      const texto = textoNota.value.trim();
      if(!titulo || !texto) return;

      const agora = new Date();
      const timestamp = agora.getTime();

      const dataHora =
        agora.toLocaleDateString("pt-BR")+" "+
        agora.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

      motoInfo.historico.push({
        titulo,
        texto,
        dataHora,
        timestamp
      });

      renderizarHistorico(motoInfo);

      ultimaAtualizacao.textContent =
        "√öltima atualiza√ß√£o: " + dataHora;

      tituloNota.value = "";
      textoNota.value = "";
    };
  // üîπ TROCA DE √ìLEO
  document.getElementById("salvarTrocaOleo").onclick = () => {
    if (!motoSelecionada) {
      return alert("Nenhuma moto selecionada.");
    }

    const tipoOleo = document.getElementById("tipoOleo").value.trim();
    const kmAtual = parseInt(document.getElementById("kmAtual").value) || 0;
    const kmProx = parseInt(document.getElementById("kmProximaTroca").value) || 0;
    const mesesProx = parseInt(document.getElementById("mesesProximaTroca").value) || 0;

    if (!tipoOleo && !kmAtual && !kmProx && !mesesProx) return alert("Preencha ao menos algum campo.");

    const agora = new Date();
    let dataProx = null;
    if (mesesProx) {
      dataProx = new Date();
      dataProx.setMonth(agora.getMonth() + mesesProx);
    }

    motoSelecionada.oleo = {
      tipo: tipoOleo,
      kmAtual,
      kmProx,
      mesesProx,
      dataProx: dataProx ? dataProx.getTime() : null
    };

    alertaTrocaOleo.textContent = "Troca registrada com sucesso.";
    formTrocaOleo.classList.add("d-none");
    verificarAlertasTrocaOleo();
  };

  // üîπ VERIFICAR ALERTAS DE TROCA DE √ìLEO
  function verificarAlertasTrocaOleo() {
    const lista = document.getElementById("listaAlertas");
    const badge = document.getElementById("contagemAlertas");

    lista.innerHTML = "";
    let totalAlertas = 0;
    const agora = Date.now();

    document.querySelectorAll("#cardsContainer .col").forEach(col => {
      const motoInfo = col.motoInfo;
      if (!motoInfo || !motoInfo.oleo) return;

      const mensagens = [];
      const oleo = motoInfo.oleo;

      if (oleo.kmProx && oleo.kmAtual >= oleo.kmProx) mensagens.push("Quilometragem atingida");
      if (oleo.dataProx && agora >= oleo.dataProx) mensagens.push("Prazo de meses vencido");

      if (mensagens.length) {
        totalAlertas++;
        const li = document.createElement("li");
        li.className = "dropdown-item text-danger";
        li.style.cursor = "pointer";
        li.innerHTML = `<strong>${motoInfo.nome}</strong> - ${motoInfo.placa}<br><small>${mensagens.join(" / ")}</small>`;
        li.onclick = () => {
          document.getElementById("btnAlertas").click();
          motoSelecionada = motoInfo;
          motoInfo.card.querySelector("button").click();
        };
        lista.appendChild(li);
      }
    });

    badge.textContent = totalAlertas;
  }

  setInterval(verificarAlertasTrocaOleo, 60000);
  verificarAlertasTrocaOleo();

  // üîπ FUN√á√ÉO VAZIA DE DETALHES (adicione depois)
  function adicionarEventoDetalhes(col, motoInfo) {
    const btnDetalhes = col.querySelector("button.btn-outline-warning");
    btnDetalhes.onclick = () => {
      motoSelecionada = motoInfo;
      // Aqui voc√™ pode abrir modal detalhes
      const detalhesModal = new bootstrap.Modal(document.getElementById("detalhesModal"));
      detalhesModal.show();

      document.getElementById("detalhesTitulo").textContent = motoInfo.nome;
      document.getElementById("detalhesPlaca").textContent = `Placa: ${motoInfo.placa}`;
      document.getElementById("detalhesCliente").textContent = `Cliente: ${motoInfo.clienteNome}`;
      document.getElementById("detalhesContato").textContent = `Contato: ${motoInfo.clienteContato}`;
      document.getElementById("detalhesStatusSelect").value = motoInfo.statusTexto === "Em andamento" ? "andamento" : "concluido";
    };
  }
</script>





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>