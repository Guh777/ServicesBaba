<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babalu Motos Services</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="./style.css">
</head>

<body>

<nav class="navbar bg-body-tertiary">
<div class="container-fluid">

<form class="d-flex">
<input class="form-control me-2" type="search" placeholder="Search"/>
<button class="btn btn-outline-success">Pesquisar</button>
</form>

<button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#novoServicoModal">
<i class="bi bi-plus-circle"></i> Adicionar Novo
</button>

</div>
</nav>


  <div class="container">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 justify-content-center" id="cardsContainer">
      <!-- Cards existentes -->
      
    </div>
  </div>
<!-- Modal novo servi√ßo -->
<div class="modal fade" id="novoServicoModal">
<div class="modal-dialog">
<div class="modal-content">

<div class="modal-header">
<h5>Novo Servi√ßo</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<input class="form-control mb-2" placeholder="Nome da Moto" id="motoNome">
<input class="form-control mb-2" placeholder="Placa" id="placa">
<input class="form-control mb-2" placeholder="Cliente" id="clienteNome">
<input class="form-control mb-2" placeholder="Contato" id="clienteContato">

<select class="form-select mb-2" id="status">
<option value="andamento">Em andamento</option>
<option value="concluido">Servi√ßo conclu√≠do</option>
</select>

<input class="form-control" placeholder="URL imagem" id="imagem">
</div>

<div class="modal-footer">
<button class="btn btn-success" id="salvarServico">Salvar</button>
</div>

</div>
</div>
</div>

<!-- Modal detalhes -->
<div class="modal fade" id="detalhesModal">
<div class="modal-dialog modal-lg">
<div class="modal-content">

<div class="modal-header">
<h5 id="detalhesTitulo"></h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">

<p id="detalhesPlaca"></p>
<p id="detalhesCliente"></p>
<p id="detalhesContato"></p>

<select class="form-select mb-3" id="detalhesStatusSelect">
<option value="andamento">Em andamento</option>
<option value="concluido">Servi√ßo conclu√≠do</option>
</select>

<hr>

<h6 class="fw-bold">Hist√≥rico do Servi√ßo</h6>

<div class="accordion mb-2" id="historicoAccordion"></div>

<small id="ultimaAtualizacao" class="text-muted d-block mb-2"></small>

<input class="form-control mb-1" id="tituloNota" placeholder="T√≠tulo da anota√ß√£o">
<textarea class="form-control mb-2" id="textoNota" rows="2" placeholder="Descri√ß√£o do servi√ßo..."></textarea>

<button class="btn btn-outline-primary w-100" id="adicionarNota">
<i class="bi bi-plus-lg"></i> Adicionar anota√ß√£o
</button>

</div>
</div>
</div>
</div>

<script>
document.getElementById("salvarServico").onclick = () => {

const nomeMoto = motoNome.value.trim();
const placaMoto = placa.value.trim();
const cliente = clienteNome.value.trim();
const contato = clienteContato.value.trim();
const status = document.getElementById("status").value;
const imagem = document.getElementById("imagem").value || "./img/default.jpg";

if(!nomeMoto || !placaMoto || !cliente) return alert("Preencha tudo");

const statusTexto = status === "andamento" ? "Em andamento" : "Servi√ßo conclu√≠do";
const statusCor = status === "andamento" ? "text-danger" : "text-success";

const col = document.createElement("div");
col.className = "col";

col.innerHTML = `
<div class="card">
<img src="${imagem}" class="card-img-top">
<div class="card-body">
<h5 class="card-title">${nomeMoto}</h5>
<p class="card-text"><strong>Placa:</strong> ${placaMoto}</p>
<p class="fs-6 fw-bold ${statusCor}">${statusTexto}</p>
<button class="btn btn-outline-warning">Detalhes</button>
</div>
</div>
`;

const motoInfo = {
nome: nomeMoto,
placa: placaMoto,
clienteNome: cliente,
clienteContato: contato,
statusTexto,
imagem,
historico: [],
contador: 0
};

adicionarEventoDetalhes(col, motoInfo);
cardsContainer.appendChild(col);

bootstrap.Modal.getInstance(novoServicoModal).hide();
};

// üîπ LIMPAR MODAL AO ABRIR
novoServicoModal.addEventListener("show.bs.modal", () => {
motoNome.value = "";
placa.value = "";
clienteNome.value = "";
clienteContato.value = "";
imagem.value = "";
status.value = "andamento";
});

// üîπ RENDERIZA HIST√ìRICO ORDENADO
function renderizarHistorico(motoInfo){
historicoAccordion.innerHTML = "";

motoInfo.historico
.sort((a,b) => b.timestamp - a.timestamp)
.forEach(nota => adicionarNotaUI(nota));
}

function adicionarEventoDetalhes(card, motoInfo){

card.querySelector("button").onclick = () => {

// Dados
detalhesTitulo.textContent = motoInfo.nome;
detalhesPlaca.innerHTML = "<b>Placa:</b> " + motoInfo.placa;
detalhesCliente.innerHTML = "<b>Cliente:</b> " + motoInfo.clienteNome;
detalhesContato.innerHTML = "<b>Contato:</b> " + (motoInfo.clienteContato || "-");

// Select
detalhesStatusSelect.value =
motoInfo.statusTexto === "Em andamento" ? "andamento" : "concluido";

// Hist√≥rico
renderizarHistorico(motoInfo);

// üî• STATUS AUTOM√ÅTICO
detalhesStatusSelect.onchange = () => {

const agora = new Date();
const timestamp = agora.getTime();

const novoStatus = detalhesStatusSelect.value;

const statusTexto =
novoStatus === "andamento"
? "Em andamento"
: "Servi√ßo conclu√≠do";

const statusCor =
novoStatus === "andamento"
? "text-danger"
: "text-success";

motoInfo.statusTexto = statusTexto;

// Card
const statusElemento =
card.querySelector(".card-body p.fw-bold");

statusElemento.textContent = statusTexto;
statusElemento.classList.remove("text-danger","text-success");
statusElemento.classList.add(statusCor);

// Move card
if(novoStatus === "concluido"){
cardsContainer.appendChild(card);
}else{
cardsContainer.prepend(card);
}

// Data
const dataHora =
agora.toLocaleDateString("pt-BR")+" "+
agora.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

ultimaAtualizacao.textContent =
"√öltima atualiza√ß√£o: " + dataHora;

// Hist√≥rico
motoInfo.historico.push({
titulo: "Status alterado",
texto: "Status alterado para: " + statusTexto,
dataHora,
timestamp
});

renderizarHistorico(motoInfo);
};

// üìù ANOTA√á√ÉO
adicionarNota.onclick = () => {

const titulo = tituloNota.value.trim();
const texto = textoNota.value.trim();
if(!titulo || !texto) return;

const agora = new Date();
const timestamp = agora.getTime();

const dataHora =
agora.toLocaleDateString("pt-BR")+" "+
agora.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

motoInfo.historico.push({
titulo,
texto,
dataHora,
timestamp
});

renderizarHistorico(motoInfo);

ultimaAtualizacao.textContent = "√öltima atualiza√ß√£o: " + dataHora;

tituloNota.value = "";
textoNota.value = "";
};

new bootstrap.Modal(detalhesModal).show();
};
}

function adicionarNotaUI(nota){

  const id = "nota_" + nota.timestamp;

  const item = document.createElement("div");
  item.className = "accordion-item";

  item.innerHTML = `
  <h2 class="accordion-header">
    <button class="accordion-button"
      data-bs-toggle="collapse"
      data-bs-target="#${id}">
      ${nota.titulo}
      <small class="ms-2 text-muted"><strong>(${nota.dataHora})</strong></small>
    </button>
  </h2>

  <div id="${id}" class="accordion-collapse collapse">
    <div class="accordion-body">

      <div class="nota-texto" style="white-space:pre-wrap; cursor:text">
        ${nota.texto}
      </div>

      <textarea class="form-control d-none nota-edicao" rows="4">${nota.texto}</textarea>

      <button class="btn btn-sm btn-success mt-2 d-none salvar-nota">
        <i class="bi bi-check-lg"></i> Salvar
      </button>

    </div>
  </div>
  `;

  historicoAccordion.appendChild(item);

  const divTexto = item.querySelector(".nota-texto");
  const textarea = item.querySelector(".nota-edicao");
  const btnSalvar = item.querySelector(".salvar-nota");

  let textoOriginal = nota.texto;

  /* üëâ CLICOU NO TEXTO ‚Üí EDITAR */
  divTexto.onclick = () => {
    divTexto.classList.add("d-none");
    textarea.classList.remove("d-none");
    textarea.focus();
  };

  /* üî• MOSTRAR SALVAR S√ì SE ALTERAR */
  textarea.addEventListener("input", () => {
    if (textarea.value.trim() !== textoOriginal.trim()) {
      btnSalvar.classList.remove("d-none");
    } else {
      btnSalvar.classList.add("d-none");
    }
  });

  /* üíæ SALVAR */
  btnSalvar.onclick = () => {
  const novoTexto = textarea.value.trim();
  if (!novoTexto) return;

  const agora = new Date();

  nota.texto = novoTexto;
  nota.dataHora =
    agora.toLocaleDateString("pt-BR") + " " +
    agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });

  nota.timestamp = agora.getTime();

  // atualiza texto vis√≠vel
  divTexto.textContent = novoTexto;

  // sai do modo edi√ß√£o
  textarea.classList.add("d-none");
  divTexto.classList.remove("d-none");

  // üî• ESCONDE O BOT√ÉO SALVAR
  btnSalvar.classList.add("d-none");

  // atualiza refer√™ncia do texto original
  textoOriginal = novoTexto;
};

}



</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
