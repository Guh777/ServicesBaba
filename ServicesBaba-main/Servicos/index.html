<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babalu Motos Services</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="./style.css">
</head>

<body>
<div id="loginScreen" class="d-flex vh-100 justify-content-center align-items-center bg-dark">
  <div class="card p-4 shadow" style="width: 350px;">
    <h4 class="text-center mb-3">Babalu Motos</h4>

    <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
    <input type="password" id="loginSenha" class="form-control mb-3" placeholder="Senha">

    <button class="btn btn-primary w-100" id="btnLogin">Entrar</button>

    <small class="text-danger mt-2 d-none" id="loginErro"></small>
  </div>
</div>
<div id="app" class="d-none">
<nav class="navbar">
  <div class="container-fluid position-relative d-flex align-items-center">

    <!-- ESQUERDA -->
    <div class="d-flex align-items-center gap-2">
      <input class="form-control" type="search" placeholder="Digite o Nome/Placa" id="searchInput"/>
    </div>

    <!-- TEXTO ESQUERDO -->
    <div class="nav-text nav-text-left">BABALU</div>

    <!-- LOGO CENTRAL -->
    <div class="nav-logo">
      <img src="./img/logobaba.png" alt="Babalu Motos">
    </div>

    <!-- TEXTO DIREITO -->
    <div class="nav-text nav-text-right">MOTOS</div>

    <!-- DIREITA -->
    <div class="ms-auto">
      <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#novoServicoModal">
        <i class="bi bi-plus-circle"></i> Adicionar Novo
      </button>
    </div>

  </div>
</nav>

<div class="dropdown d-inline">
  <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btnAlertas">
    ‚ö† Troca de √ìleo <span class="badge bg-danger" id="contagemAlertas">0</span>
  </button>
  <ul class="dropdown-menu" id="listaAlertas" style="width: 350px; max-height: 400px; overflow-y:auto;">
    <!-- Alertas ser√£o inseridos aqui -->
  </ul>
</div>

<!-- Cards -->
  <div class="container">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 justify-content-center" id="cardsContainer">
      
      
    </div>
  </div>
<!-- Modal novo servi√ßo -->
<div class="modal fade" id="novoServicoModal">
<div class="modal-dialog">
<div class="modal-content">

<div class="modal-header">
<h5>Novo Servi√ßo</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<input class="form-control mb-2" placeholder="Nome da Moto" id="motoNome">
<input class="form-control mb-2" placeholder="Placa" id="placa">
<input class="form-control mb-2" placeholder="Cliente" id="clienteNome">
<input class="form-control mb-2" placeholder="Contato" id="clienteContato">

<select class="form-select mb-2" id="status">
<option value="andamento">Em andamento</option>
<option value="concluido">Servi√ßo conclu√≠do</option>
</select>

<input class="form-control" placeholder="URL imagem" id="imagem">
</div>

<div class="modal-footer">
<button class="btn btn-success" id="salvarServico">Salvar</button>
</div>

</div>
</div>
</div>

<!-- Modal detalhes -->
<div class="modal fade" id="detalhesModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="detalhesTitulo"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-4">

          <!-- BLOCO ESQUERDO: DADOS DA MOTO/CLIENTE -->
          <div class="col-md-5">
            <div class="card p-4 shadow-sm w-100" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Informa√ß√µes da Moto</h5>
              <p id="detalhesPlaca"></p>
              <p id="detalhesCliente"></p>
              <p id="detalhesContato"></p>

              <select class="form-select mt-3" id="detalhesStatusSelect">
                <option value="andamento">Em andamento</option>
                <option value="concluido">Servi√ßo conclu√≠do</option>
              </select>
              <!-- Bot√£o Troca de √ìleo -->
<button class="btn btn-outline-success w-100 mb-2" type="button" id="btnTrocaOleo">
  <i class="bi bi-droplet"></i> Troca de √ìleo
</button>

<!-- Formul√°rio de Troca de √ìleo (inicialmente escondido) -->
<div class="card p-3 mb-2 d-none" id="formTrocaOleo">
  <h6>Registrar Troca de √ìleo</h6>

  <input class="form-control mb-2" id="tipoOleo" placeholder="Tipo de √ìleo">
  <input type="number" class="form-control mb-2" id="kmAtual" placeholder="Quilometragem atual">
  <input type="number" class="form-control mb-2" id="kmProximaTroca" placeholder="Pr√≥xima troca (km)">
  <input type="number" class="form-control mb-2" id="mesesProximaTroca" placeholder="Pr√≥xima troca (meses)">

  <button class="btn btn-success w-100" id="salvarTrocaOleo">Salvar Troca</button>

  <small class="text-danger mt-2 d-block" id="alertaTrocaOleo"></small>
</div>
            </div>
          </div>

          <!-- BLOCO DIREITO: HIST√ìRICO E ANOTA√á√ïES -->
          <div class="col-md-7">
            <div class="card p-4 shadow-sm w-100 d-flex flex-column" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Hist√≥rico e Anota√ß√µes</h5>

              <!-- Hist√≥rico com scroll apenas nele -->
              <div class="accordion mb-3 flex-grow-1 overflow-auto" id="historicoAccordion" style="max-height: 60vh;"></div>

              <small id="ultimaAtualizacao" class="text-muted d-block mb-3"></small>

              <input class="form-control mb-2" id="tituloNota" placeholder="T√≠tulo da anota√ß√£o">
              <textarea class="form-control mb-2" id="textoNota" rows="3" placeholder="Descri√ß√£o do servi√ßo..."></textarea>

              <button class="btn btn-outline-primary w-100 mb-2" id="adicionarNota">
                <i class="bi bi-plus-lg"></i> Adicionar anota√ß√£o
              </button>


              <button class="btn btn-danger w-100 mt-auto" id="excluirMoto">
                <i class="bi bi-trash"></i> Excluir Moto
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>



<!-- Modal Galeria -->
<div class="modal fade" id="galeriaModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Galeria do Servi√ßo</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="file" class="form-control mb-3" id="uploadFotos" multiple accept="image/*">

        <div class="row g-3" id="galeriaContainer"></div>

      </div>
    </div>
  </div>
</div>
<!-- Modal Foto Tela Cheia -->
 <div class="modal fade" id="fotoModal">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">

      <div class="modal-body d-flex justify-content-center align-items-center">
        <img id="fotoGrande" class="img-fluid">
      </div>

      <button class="btn btn-light position-fixed top-0 end-0 m-3" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i>
      </button>

    </div>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDocs,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC48hyWdVdL1d54DMyys7qq2o7zp2tpxHc",
    authDomain: "babalu-motos.firebaseapp.com",
    projectId: "babalu-motos",
    storageBucket: "babalu-motos.appspot.com",
    messagingSenderId: "56196844709",
    appId: "1:56196844709:web:dba13125edd80228f1914c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // üîì exp√µe pro resto do c√≥digo
  window.auth = auth;
  window.db = db;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.signOut = signOut;
  window.onAuthStateChanged = onAuthStateChanged;
  window.collection = collection;
  window.doc = doc;
  window.setDoc = setDoc;
  window.getDocs = getDocs;
  window.deleteDoc = deleteDoc;
</script>

<script>
  let indiceNotaEditando = null;

/* =========================
   ELEMENTOS PRINCIPAIS
========================= */
const loginScreen = document.getElementById("loginScreen");
const appScreen = document.getElementById("app");
const erroLogin = document.getElementById("loginErro");
const cardsContainer = document.getElementById("cardsContainer");

/* =========================
   LOGIN SIMPLES
========================= */
document.getElementById("btnLogin").onclick = () => {
  const email = loginEmail.value.trim();
  const senha = loginSenha.value.trim();

  if (!email || !senha) {
    erroLogin.textContent = "Preencha email e senha!";
    erroLogin.classList.remove("d-none");
    return;
  }

  loginScreen.classList.add("d-none");
  appScreen.classList.remove("d-none");
};

/* =========================
   VARI√ÅVEL GLOBAL
========================= */
let motoSelecionada = null;

/* =========================
   MODAL NOVO SERVI√áO
========================= */
const novoServicoModal = document.getElementById("novoServicoModal");
const salvarServicoBtn = document.getElementById("salvarServico");

salvarServicoBtn.onclick = () => {
  if (!motoNome.value || !placa.value || !clienteNome.value) {
    alert("Preencha os campos obrigat√≥rios!");
    return;
  }

  const statusValor = status.value;
  const statusTexto = statusValor === "andamento"
    ? "Em andamento"
    : "Servi√ßo conclu√≠do";

  const statusCor = statusValor === "andamento"
    ? "text-danger"
    : "text-success";

  const col = document.createElement("div");
  col.className = "col";
  col.innerHTML = `
    <div class="card">
      <img src="${imagem.value || "./img/default.jpg"}" class="card-img-top">
      <div class="card-body">
        <h5>${motoNome.value}</h5>
        <p><strong>Placa:</strong> ${placa.value}</p>
        <p class="fw-bold ${statusCor}">${statusTexto}</p>
        <button class="btn btn-outline-warning btn-detalhes">Detalhes</button>
        <button class="btn btn-outline-secondary btn-galeria">Galeria</button>
      </div>
    </div>
  `;

  const motoInfo = {
    nome: motoNome.value,
    placa: placa.value,
    clienteNome: clienteNome.value,
    clienteContato: clienteContato.value,
    status: statusValor,
    statusTexto,
    statusCor,
    historico: [],
    galeria: [],
    oleo: null,
    card: col
  };

  col.motoInfo = motoInfo;
  adicionarEventos(col, motoInfo);
  cardsContainer.appendChild(col);
  ordenarMotos();

  bootstrap.Modal.getInstance(novoServicoModal).hide();
};

/* =========================
   LIMPAR MODAL
========================= */
novoServicoModal.addEventListener("show.bs.modal", () => {
  motoNome.value = "";
  placa.value = "";
  clienteNome.value = "";
  clienteContato.value = "";
  imagem.value = "";
  status.value = "andamento";
});

/* =========================
   EVENTOS DOS CARDS
========================= */
function adicionarEventos(col, motoInfo) {
  col.querySelector(".btn-detalhes").onclick = () => abrirDetalhes(motoInfo);
  col.querySelector(".btn-galeria").onclick = () => {
    motoSelecionada = motoInfo;
    galeriaContainer.innerHTML = "";
    motoInfo.galeria.forEach(img => adicionarImagemGaleria(img));
    new bootstrap.Modal(galeriaModal).show();
  };
}

/* =========================
   MODAL DETALHES
========================= */
function abrirDetalhes(motoInfo) {
  motoSelecionada = motoInfo;

  detalhesTitulo.textContent = motoInfo.nome;
  detalhesPlaca.textContent = "Placa: " + motoInfo.placa;
  detalhesCliente.textContent = "Cliente: " + motoInfo.clienteNome;
  detalhesContato.textContent = "Contato: " + motoInfo.clienteContato;
  detalhesStatusSelect.value = motoInfo.status;

  renderizarHistorico();
  new bootstrap.Modal(detalhesModal).show();
}

/* =========================
   STATUS + ORDENA√á√ÉO
========================= */
detalhesStatusSelect.onchange = () => {
  if (!motoSelecionada) return;

  motoSelecionada.status = detalhesStatusSelect.value;

  if (motoSelecionada.status === "andamento") {
    motoSelecionada.statusTexto = "Em andamento";
    motoSelecionada.statusCor = "text-danger";
  } else {
    motoSelecionada.statusTexto = "Servi√ßo conclu√≠do";
    motoSelecionada.statusCor = "text-success";
  }

  const statusP = motoSelecionada.card.querySelector("p.fw-bold");
  statusP.textContent = motoSelecionada.statusTexto;
  statusP.className = `fw-bold ${motoSelecionada.statusCor}`;

  ordenarMotos();
};

function ordenarMotos() {
  [...cardsContainer.children]
    .sort((a, b) =>
      (a.motoInfo.status === "andamento" ? 0 : 1) -
      (b.motoInfo.status === "andamento" ? 0 : 1)
    )
    .forEach(card => cardsContainer.appendChild(card));
}

/* =========================
   HIST√ìRICO
========================= */
adicionarNota.onclick = () => {
  if (!motoSelecionada) return;

  const titulo = tituloNota.value.trim();
  const texto = textoNota.value.trim();
  if (!titulo || !texto) return;

  const dataHora = new Date().toLocaleString("pt-BR");

  // ‚úèÔ∏è EDITANDO
  if (indiceNotaEditando !== null) {
    motoSelecionada.historico[indiceNotaEditando] = {
      titulo,
      texto,
      dataHora
    };

    indiceNotaEditando = null;
    adicionarNota.textContent = "Adicionar anota√ß√£o";
  }
  // ‚ûï NOVA NOTA
  else {
    motoSelecionada.historico.push({
      titulo,
      texto,
      dataHora
    });
  }

  renderizarHistorico();
  ultimaAtualizacao.textContent = "√öltima atualiza√ß√£o: " + dataHora;

  tituloNota.value = "";
  textoNota.value = "";
};


function renderizarHistorico() {
  historicoAccordion.innerHTML = "";

  motoSelecionada.historico.forEach((item, i) => {
    const div = document.createElement("div");
    div.className = "accordion-item";

    div.innerHTML = `
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
          data-bs-toggle="collapse" data-bs-target="#nota${i}">
          ${item.titulo}
        </button>
      </h2>
      <div id="nota${i}" class="accordion-collapse collapse">
        <div class="accordion-body" style="cursor:pointer">
          ${item.texto}<br>
          <small class="text-muted">${item.dataHora}</small>
          <hr>
          <small class="text-primary">Clique para editar</small>
        </div>
      </div>
    `;

    // üëâ clique para editar
    div.querySelector(".accordion-body").onclick = () => {
      tituloNota.value = item.titulo;
      textoNota.value = item.texto;
      indiceNotaEditando = i;
      adicionarNota.textContent = "Salvar edi√ß√£o";
    };

    historicoAccordion.appendChild(div);
  });
}

/* =========================
   EXCLUIR MOTO
========================= */
excluirMoto.onclick = () => {
  if (!motoSelecionada || !confirm("Excluir esta moto?")) return;
  motoSelecionada.card.remove();
  motoSelecionada = null;
  bootstrap.Modal.getInstance(detalhesModal).hide();
};

/* =========================
   TROCA DE √ìLEO
========================= */
btnTrocaOleo.onclick = () => formTrocaOleo.classList.toggle("d-none");

salvarTrocaOleo.onclick = () => {
  if (!motoSelecionada) return;

  const agora = new Date();
  let dataProx = mesesProximaTroca.value
    ? new Date(agora.setMonth(agora.getMonth() + Number(mesesProximaTroca.value)))
    : null;

  motoSelecionada.oleo = {
    kmAtual: Number(kmAtual.value),
    kmProx: Number(kmProximaTroca.value),
    dataProx: dataProx ? dataProx.getTime() : null
  };

  alertaTrocaOleo.textContent = "Troca registrada com sucesso!";
  verificarAlertasTrocaOleo();
};

/* =========================
   ALERTAS
========================= */
function verificarAlertasTrocaOleo() {
  listaAlertas.innerHTML = "";
  let total = 0;
  const agora = Date.now();

  document.querySelectorAll(".col").forEach(col => {
    const m = col.motoInfo;
    if (!m?.oleo) return;

    if (
      (m.oleo.kmProx && m.oleo.kmAtual >= m.oleo.kmProx) ||
      (m.oleo.dataProx && agora >= m.oleo.dataProx)
    ) {
      total++;
      const li = document.createElement("li");
      li.className = "dropdown-item text-danger";
      li.textContent = `${m.nome} - ${m.placa}`;
      li.onclick = () => abrirDetalhes(m);
      listaAlertas.appendChild(li);
    }
  });

  contagemAlertas.textContent = total;
}

/* =========================
   GALERIA
========================= */
uploadFotos.onchange = () => {
  if (!motoSelecionada) return;

  [...uploadFotos.files].forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      motoSelecionada.galeria.push(e.target.result);
      adicionarImagemGaleria(e.target.result);
    };
    reader.readAsDataURL(file);
  });

  uploadFotos.value = "";
};

function adicionarImagemGaleria(img) {
  const div = document.createElement("div");
  div.className = "col-md-3";
  div.innerHTML = `<img src="${img}" class="img-fluid rounded">`;
  div.onclick = () => {
    fotoGrande.src = img;
    new bootstrap.Modal(fotoModal).show();
  };
  galeriaContainer.appendChild(div);
}
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>