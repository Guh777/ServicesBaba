<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babalu Motos Services</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="./style.css">
</head>

<body>
<div id="loginScreen" class="d-flex vh-100 justify-content-center align-items-center bg-dark">
  <div class="card p-4 shadow" style="width: 350px;">
    <h4 class="text-center mb-3">Babalu Motos</h4>

    <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
    <input type="password" id="loginSenha" class="form-control mb-3" placeholder="Senha">

    <button class="btn btn-primary w-100" id="btnLogin">Entrar</button>

    <small class="text-danger mt-2 d-none" id="loginErro"></small>
  </div>
</div>
<div id="app" class="d-none">
<nav class="navbar">
  <div class="container-fluid position-relative d-flex align-items-center">

    <!-- ESQUERDA -->
    <div class="d-flex align-items-center gap-2">
      <input class="form-control" type="search" placeholder="Digite o Nome/Placa" id="searchInput"/>
    </div>

    <!-- TEXTO ESQUERDO -->
    <div class="nav-text nav-text-left">BABALU</div>

    <!-- LOGO CENTRAL -->
    <div class="nav-logo">
      <img src="./img/logobaba.png" alt="Babalu Motos">
    </div>

    <!-- TEXTO DIREITO -->
    <div class="nav-text nav-text-right">MOTOS</div>

    <!-- DIREITA -->
    <div class="ms-auto">
      <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#novoServicoModal">
        <i class="bi bi-plus-circle"></i> Adicionar Novo
      </button>
    </div>

  </div>
</nav>

<div class="dropdown d-inline">
  <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btnAlertas">
    ⚠ Troca de Óleo <span class="badge bg-danger" id="contagemAlertas">0</span>
  </button>
  <ul class="dropdown-menu" id="listaAlertas" style="width: 350px; max-height: 400px; overflow-y:auto;">
    <!-- Alertas serão inseridos aqui -->
  </ul>
</div>

<!-- Cards -->
  <div class="container">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 justify-content-center" id="cardsContainer">
      
      
    </div>
  </div>
<!-- Modal novo serviço -->
<div class="modal fade" id="novoServicoModal">
<div class="modal-dialog">
<div class="modal-content">

<div class="modal-header">
<h5>Novo Serviço</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<input class="form-control mb-2" placeholder="Nome da Moto" id="motoNome">
<input class="form-control mb-2" placeholder="Placa" id="placa">
<input class="form-control mb-2" placeholder="Cliente" id="clienteNome">
<input class="form-control mb-2" placeholder="Contato" id="clienteContato">

<select class="form-select mb-2" id="status">
<option value="andamento">Em andamento</option>
<option value="concluido">Serviço concluído</option>
</select>

<input class="form-control" placeholder="URL imagem" id="imagem">
</div>

<div class="modal-footer">
<button class="btn btn-success" id="salvarServico">Salvar</button>
</div>

</div>
</div>
</div>

<!-- Modal detalhes -->
<div class="modal fade" id="detalhesModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="detalhesTitulo"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-4">

          <!-- BLOCO ESQUERDO: DADOS DA MOTO/CLIENTE -->
          <div class="col-md-5">
            <div class="card p-4 shadow-sm w-100" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Informações da Moto</h5>
              <p id="detalhesPlaca"></p>
              <p id="detalhesCliente"></p>
              <p id="detalhesContato"></p>

              <select class="form-select mt-3" id="detalhesStatusSelect">
                <option value="andamento">Em andamento</option>
                <option value="concluido">Serviço concluído</option>
              </select>
              <!-- Botão Troca de Óleo -->
<button class="btn btn-outline-success w-100 mb-2" type="button" id="btnTrocaOleo">
  <i class="bi bi-droplet"></i> Troca de Óleo
</button>

<!-- Formulário de Troca de Óleo (inicialmente escondido) -->
<div class="card p-3 mb-2 d-none" id="formTrocaOleo">
  <h6>Registrar Troca de Óleo</h6>

  <input class="form-control mb-2" id="tipoOleo" placeholder="Tipo de Óleo">
  <input type="number" class="form-control mb-2" id="kmAtual" placeholder="Quilometragem atual">
  <input type="number" class="form-control mb-2" id="kmProximaTroca" placeholder="Próxima troca (km)">
  <input type="number" class="form-control mb-2" id="mesesProximaTroca" placeholder="Próxima troca (meses)">

  <button class="btn btn-success w-100" id="salvarTrocaOleo">Salvar Troca</button>

  <small class="text-danger mt-2 d-block" id="alertaTrocaOleo"></small>
</div>
            </div>
          </div>

          <!-- BLOCO DIREITO: HISTÓRICO E ANOTAÇÕES -->
          <div class="col-md-7">
            <div class="card p-4 shadow-sm w-100 d-flex flex-column" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Histórico e Anotações</h5>

              <!-- Histórico com scroll apenas nele -->
              <div class="accordion mb-3 flex-grow-1 overflow-auto" id="historicoAccordion" style="max-height: 60vh;"></div>

              <small id="ultimaAtualizacao" class="text-muted d-block mb-3"></small>

              <input class="form-control mb-2" id="tituloNota" placeholder="Título da anotação">
              <textarea class="form-control mb-2" id="textoNota" rows="3" placeholder="Descrição do serviço..."></textarea>

              <button class="btn btn-outline-primary w-100 mb-2" id="adicionarNota">
                <i class="bi bi-plus-lg"></i> Adicionar anotação
              </button>


              <button class="btn btn-danger w-100 mt-auto" id="excluirMoto">
                <i class="bi bi-trash"></i> Excluir Moto
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>



<!-- Modal Galeria -->
<div class="modal fade" id="galeriaModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Galeria do Serviço</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="file" class="form-control mb-3" id="uploadFotos" multiple accept="image/*">

        <div class="row g-3" id="galeriaContainer"></div>

      </div>
    </div>
  </div>
</div>
<!-- Modal Foto Tela Cheia -->
 <div class="modal fade" id="fotoModal">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">

      <div class="modal-body d-flex justify-content-center align-items-center">
        <img id="fotoGrande" class="img-fluid">
      </div>

      <button class="btn btn-light position-fixed top-0 end-0 m-3" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i>
      </button>

    </div>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    doc, 
    setDoc, 
    getDocs, 
    deleteDoc, 
    updateDoc 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC48hyWdVdL1d54DMyys7qq2o7zp2tpxHc",
    authDomain: "babalu-motos.firebaseapp.com",
    projectId: "babalu-motos",
    storageBucket: "babalu-motos.appspot.com",
    messagingSenderId: "56196844709",
    appId: "1:56196844709:web:dba13125edd80228f1914c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Elementos principais
  const loginScreen = document.getElementById("loginScreen");
  const appScreen = document.getElementById("app");
  const erroLogin = document.getElementById("loginErro");
  const loginEmail = document.getElementById("loginEmail");
  const loginSenha = document.getElementById("loginSenha");
  const btnLogin = document.getElementById("btnLogin");
  const cardsContainer = document.getElementById("cardsContainer");

  // Global
  let motoSelecionada = null;
  let motosData = {};
  let indiceNotaEditando = null;

  /* =========================
     LOGIN FIREBASE
  ========================== */
  btnLogin.onclick = async () => {
    const email = loginEmail.value.trim();
    const senha = loginSenha.value.trim();

    if (!email || !senha) {
      erroLogin.textContent = "Preencha email e senha!";
      erroLogin.classList.remove("d-none");
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, senha);
      erroLogin.classList.add("d-none");
    } catch (err) {
      erroLogin.textContent = "Email ou senha incorretos!";
      erroLogin.classList.remove("d-none");
    }
  };

  onAuthStateChanged(auth, user => {
    if (user) {
      loginScreen.classList.add("d-none");
      appScreen.classList.remove("d-none");
      carregarMotosFirestore();
    } else {
      loginScreen.classList.remove("d-none");
      appScreen.classList.add("d-none");
    }
  });

  /* =========================
     FUNÇÕES FIRESTORE
  ========================== */
  async function salvarMotoFirestore(moto) {
    await setDoc(doc(db, "motos", moto.placa), moto);
  }

  async function atualizarMotoFirestore(placa, dados) {
    await updateDoc(doc(db, "motos", placa), dados);
  }

  async function excluirMotoFirestore(placa) {
    await deleteDoc(doc(db, "motos", placa));
  }

  async function carregarMotosFirestore() {
    cardsContainer.innerHTML = "";
    motosData = {};
    const snapshot = await getDocs(collection(db, "motos"));
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      motosData[data.placa] = data;

      const col = criarCard(data);
      data.card = col;
      col.motoInfo = data;
      adicionarEventos(col, data);
      cardsContainer.appendChild(col);
    });

    ordenarMotos();
    verificarAlertasTrocaOleo();
  }

  /* =========================
     CRIAÇÃO DE CARD
  ========================== */
  function criarCard(data) {
    const col = document.createElement("div");
    col.className = "col";
    col.innerHTML = `
      <div class="card">
        <img src="${data.imagem || "./img/default.jpg"}" class="card-img-top">
        <div class="card-body">
          <h5>${data.nome}</h5>
          <p><strong>Placa:</strong> ${data.placa}</p>
          <p class="fw-bold ${data.statusCor}">${data.statusTexto}</p>
          <button class="btn btn-outline-warning btn-detalhes">Detalhes</button>
          <button class="btn btn-outline-secondary btn-galeria">Galeria</button>
        </div>
      </div>
    `;
    return col;
  }

  /* =========================
     MODAL NOVO SERVIÇO
  ========================== */
  const novoServicoModal = document.getElementById("novoServicoModal");
  const salvarServicoBtn = document.getElementById("salvarServico");
// Inputs do modal de novo serviço
const motoNome = document.getElementById("motoNome");
const placa = document.getElementById("placa");
const clienteNome = document.getElementById("clienteNome");
const clienteContato = document.getElementById("clienteContato");
const status = document.getElementById("status");
const imagem = document.getElementById("imagem");

  salvarServicoBtn.onclick = async () => {
    if (!motoNome.value || !placa.value || !clienteNome.value) {
      alert("Preencha os campos obrigatórios!");
      return;
    }

    const statusValor = status.value;
    const statusTexto = statusValor === "andamento" ? "Em andamento" : "Serviço concluído";
    const statusCor = statusValor === "andamento" ? "text-danger" : "text-success";

    const motoInfo = {
      nome: motoNome.value,
      placa: placa.value,
      clienteNome: clienteNome.value,
      clienteContato: clienteContato.value,
      status: statusValor,
      statusTexto,
      statusCor,
      historico: [],
      galeria: [],
      oleo: null,
      imagem: imagem.value || "./img/default.jpg"
    };

    await salvarMotoFirestore(motoInfo);

    const col = criarCard(motoInfo);
    motoInfo.card = col;
    col.motoInfo = motoInfo;
    motosData[motoInfo.placa] = motoInfo;

    adicionarEventos(col, motoInfo);
    cardsContainer.appendChild(col);
    ordenarMotos();
    bootstrap.Modal.getInstance(novoServicoModal).hide();
  };

  novoServicoModal.addEventListener("show.bs.modal", () => {
    motoNome.value = "";
    placa.value = "";
    clienteNome.value = "";
    clienteContato.value = "";
    imagem.value = "";
    status.value = "andamento";
  });

  /* =========================
     EVENTOS DOS CARDS
  ========================== */
  function adicionarEventos(col, motoInfo) {
    col.querySelector(".btn-detalhes").onclick = () => abrirDetalhes(motoInfo);
    col.querySelector(".btn-galeria").onclick = () => {
      motoSelecionada = motoInfo;
      galeriaContainer.innerHTML = "";
      motoInfo.galeria.forEach(img => adicionarImagemGaleria(img));
      new bootstrap.Modal(galeriaModal).show();
    };
  }

  /* =========================
     DETALHES, STATUS, HISTÓRICO
  ========================== */
  function abrirDetalhes(motoInfo) {
    motoSelecionada = motoInfo;
    detalhesTitulo.textContent = motoInfo.nome;
    detalhesPlaca.textContent = "Placa: " + motoInfo.placa;
    detalhesCliente.textContent = "Cliente: " + motoInfo.clienteNome;
    detalhesContato.textContent = "Contato: " + motoInfo.clienteContato;
    detalhesStatusSelect.value = motoInfo.status;
    renderizarHistorico();
    new bootstrap.Modal(detalhesModal).show();
  }

  detalhesStatusSelect.onchange = async () => {
    if (!motoSelecionada) return;
    motoSelecionada.status = detalhesStatusSelect.value;
    if (motoSelecionada.status === "andamento") {
      motoSelecionada.statusTexto = "Em andamento";
      motoSelecionada.statusCor = "text-danger";
    } else {
      motoSelecionada.statusTexto = "Serviço concluído";
      motoSelecionada.statusCor = "text-success";
    }
    const statusP = motoSelecionada.card.querySelector("p.fw-bold");
    statusP.textContent = motoSelecionada.statusTexto;
    statusP.className = `fw-bold ${motoSelecionada.statusCor}`;

    await atualizarMotoFirestore(motoSelecionada.placa, {
      status: motoSelecionada.status,
      statusTexto: motoSelecionada.statusTexto,
      statusCor: motoSelecionada.statusCor
    });

    ordenarMotos();
  };

  adicionarNota.onclick = async () => {
    if (!motoSelecionada) return;
    const titulo = tituloNota.value.trim();
    const texto = textoNota.value.trim();
    if (!titulo || !texto) return;

    const dataHora = new Date().toLocaleString("pt-BR");
    if (indiceNotaEditando !== null) {
      motoSelecionada.historico[indiceNotaEditando] = { titulo, texto, dataHora };
      indiceNotaEditando = null;
      adicionarNota.textContent = "Adicionar anotação";
    } else {
      motoSelecionada.historico.push({ titulo, texto, dataHora });
    }

    await atualizarMotoFirestore(motoSelecionada.placa, { historico: motoSelecionada.historico });
    renderizarHistorico();
    ultimaAtualizacao.textContent = "Última atualização: " + dataHora;
    tituloNota.value = "";
    textoNota.value = "";
  };

  function renderizarHistorico() {
    historicoAccordion.innerHTML = "";
    motoSelecionada.historico.forEach((item, i) => {
      const div = document.createElement("div");
      div.className = "accordion-item";
      div.innerHTML = `
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button"
            data-bs-toggle="collapse" data-bs-target="#nota${i}">
            ${item.titulo}
          </button>
        </h2>
        <div id="nota${i}" class="accordion-collapse collapse">
          <div class="accordion-body" style="cursor:pointer">
            ${item.texto}<br>
            <small class="text-muted">${item.dataHora}</small>
            <hr>
            <small class="text-primary">Clique para editar</small>
          </div>
        </div>
      `;
      div.querySelector(".accordion-body small.text-primary").onclick = e => {
        e.stopPropagation();
        tituloNota.value = item.titulo;
        textoNota.value = item.texto;
        indiceNotaEditando = i;
        adicionarNota.textContent = "Salvar edição";
      };
      historicoAccordion.appendChild(div);
    });
  }

  excluirMoto.onclick = async () => {
    if (!motoSelecionada || !confirm("Excluir esta moto?")) return;
    await excluirMotoFirestore(motoSelecionada.placa);
    motoSelecionada.card.remove();
    motoSelecionada = null;
    bootstrap.Modal.getInstance(detalhesModal).hide();
  };

  /* =========================
     TROCA DE ÓLEO
  ========================== */
  btnTrocaOleo.onclick = () => formTrocaOleo.classList.toggle("d-none");

  salvarTrocaOleo.onclick = async () => {
    if (!motoSelecionada) return;
    const agora = new Date();
    let dataProx = mesesProximaTroca.value
      ? new Date(agora.setMonth(agora.getMonth() + Number(mesesProximaTroca.value)))
      : null;

    motoSelecionada.oleo = {
      kmAtual: Number(kmAtual.value),
      kmProx: Number(kmProximaTroca.value),
      dataProx: dataProx ? dataProx.getTime() : null
    };

    await atualizarMotoFirestore(motoSelecionada.placa, { oleo: motoSelecionada.oleo });
    alertaTrocaOleo.textContent = "Troca registrada com sucesso!";
    verificarAlertasTrocaOleo();
  };

  /* =========================
     GALERIA
  ========================== */
  uploadFotos.onchange = async () => {
    if (!motoSelecionada) return;
    [...uploadFotos.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = async e => {
        motoSelecionada.galeria.push(e.target.result);
        await atualizarMotoFirestore(motoSelecionada.placa, { galeria: motoSelecionada.galeria });
        adicionarImagemGaleria(e.target.result);
      };
      reader.readAsDataURL(file);
    });
    uploadFotos.value = "";
  };

  function adicionarImagemGaleria(img) {
    const div = document.createElement("div");
    div.className = "col-md-3";
    div.innerHTML = `<img src="${img}" class="img-fluid rounded">`;
    div.onclick = () => {
      fotoGrande.src = img;
      new bootstrap.Modal(fotoModal).show();
    };
    galeriaContainer.appendChild(div);
  }

  /* =========================
     ORDENAÇÃO, ALERTAS E PESQUISA
  ========================== */
  function ordenarMotos() {
    [...cardsContainer.children]
      .sort((a, b) => (a.motoInfo.status === "andamento" ? 0 : 1) - (b.motoInfo.status === "andamento" ? 0 : 1))
      .forEach(card => cardsContainer.appendChild(card));
  }

  function verificarAlertasTrocaOleo() {
  listaAlertas.innerHTML = "";
  let total = 0;
  const agora = Date.now();

  Object.values(motosData).forEach(m => {
    if (!m?.oleo) return;

    const alertaKm = m.oleo.kmProx && m.oleo.kmAtual >= m.oleo.kmProx;
    const alertaData = m.oleo.dataProx && agora >= m.oleo.dataProx;

    if (alertaKm || alertaData) {
      total++;

      const li = document.createElement("li");
      li.className = "dropdown-item text-danger d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <span>${m.nome} - ${m.placa}</span>
        <button class="btn btn-sm btn-outline-secondary btn-excluir-alerta">&times;</button>
      `;

      // Clique no nome abre detalhes
      li.querySelector("span").onclick = () => abrirDetalhes(m);

      // Botão para excluir alerta
      li.querySelector(".btn-excluir-alerta").onclick = async (e) => {
        e.stopPropagation();
        if (!confirm("Deseja remover o alerta de troca de óleo desta moto?")) return;

        // Limpa os dados de óleo
        m.oleo = null;
        await atualizarMotoFirestore(m.placa, { oleo: null });

        // Atualiza visualmente a lista de alertas
        verificarAlertasTrocaOleo();
      };

      listaAlertas.appendChild(li);
    }
  });

  contagemAlertas.textContent = total;
}

  searchInput.addEventListener("input", () => {
    const termo = searchInput.value.toLowerCase();
    document.querySelectorAll("#cardsContainer .col").forEach(col => {
      const moto = col.motoInfo;
      col.style.display = (moto.nome.toLowerCase().includes(termo) || moto.placa.toLowerCase().includes(termo)) ? "" : "none";
    });
  });
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>