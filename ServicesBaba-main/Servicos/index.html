<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babalu Motos Services</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="./style.css">
</head>

<body>

<nav class="navbar bg-body-tertiary">
<div class="container-fluid">

<form class="d-flex">
<input class="form-control me-2" type="search" placeholder="Search" id="searchInput"/>
<button class="btn btn-outline-success" id="btnPesquisar">Pesquisar</button>
</form>

<button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#novoServicoModal">
<i class="bi bi-plus-circle"></i> Adicionar Novo
</button>

</div>
<!-- Aba de alertas -->
<div class="dropdown d-inline">
  <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btnAlertas">
    ⚠ Troca de Óleo <span class="badge bg-danger" id="contagemAlertas">0</span>
  </button>
  <ul class="dropdown-menu" id="listaAlertas" style="width: 350px; max-height: 400px; overflow-y:auto;">
    <!-- Alertas serão inseridos aqui -->
  </ul>
</div>

</div>
</nav>

<!-- Cards -->
<div class="container">
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 justify-content-center" id="cardsContainer"></div>
</div>

<!-- Modal novo serviço -->
<div class="modal fade" id="novoServicoModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5>Novo Serviço</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<input class="form-control mb-2" placeholder="Nome da Moto" id="motoNome">
<input class="form-control mb-2" placeholder="Placa" id="placa">
<input class="form-control mb-2" placeholder="Cliente" id="clienteNome">
<input class="form-control mb-2" placeholder="Contato" id="clienteContato">

<select class="form-select mb-2" id="status">
<option value="andamento">Em andamento</option>
<option value="concluido">Serviço concluído</option>
</select>

<input class="form-control" placeholder="URL imagem" id="imagem">
</div>

<div class="modal-footer">
<button class="btn btn-success" id="salvarServico">Salvar</button>
</div>

</div>
</div>
</div>

<!-- Modal detalhes -->
<div class="modal fade" id="detalhesModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="detalhesTitulo"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-4">

          <!-- BLOCO ESQUERDO: DADOS DA MOTO/CLIENTE -->
          <div class="col-md-5">
            <div class="card p-4 shadow-sm w-100" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Informações da Moto</h5>
              <p id="detalhesPlaca"></p>
              <p id="detalhesCliente"></p>
              <p id="detalhesContato"></p>

              <select class="form-select mt-3" id="detalhesStatusSelect">
                <option value="andamento">Em andamento</option>
                <option value="concluido">Serviço concluído</option>
              </select>

              <!-- Botão Troca de Óleo -->
              <button class="btn btn-outline-success w-100 mb-2" type="button" id="btnTrocaOleo">
                <i class="bi bi-droplet"></i> Troca de Óleo
              </button>

              <!-- Formulário de Troca de Óleo -->
              <div class="card p-3 mb-2 d-none" id="formTrocaOleo">
                <h6>Registrar Troca de Óleo</h6>
                <input class="form-control mb-2" id="tipoOleo" placeholder="Tipo de Óleo">
                <input type="number" class="form-control mb-2" id="kmAtual" placeholder="Quilometragem atual">
                <input type="number" class="form-control mb-2" id="kmProximaTroca" placeholder="Próxima troca (km)">
                <input type="number" class="form-control mb-2" id="mesesProximaTroca" placeholder="Próxima troca (meses)">
                <button class="btn btn-success w-100" id="salvarTrocaOleo">Salvar Troca</button>
                <small class="text-danger mt-2 d-block" id="alertaTrocaOleo"></small>
              </div>
            </div>
          </div>

          <!-- BLOCO DIREITO: HISTÓRICO E ANOTAÇÕES -->
          <div class="col-md-7">
            <div class="card p-4 shadow-sm w-100 d-flex flex-column" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Histórico e Anotações</h5>

              <div class="accordion mb-3 flex-grow-1 overflow-auto" id="historicoAccordion" style="max-height: 60vh;"></div>

              <small id="ultimaAtualizacao" class="text-muted d-block mb-3"></small>

              <input class="form-control mb-2" id="tituloNota" placeholder="Título da anotação">
              <textarea class="form-control mb-2" id="textoNota" rows="3" placeholder="Descrição do serviço..."></textarea>

              <button class="btn btn-outline-primary w-100 mb-2" id="adicionarNota">
                <i class="bi bi-plus-lg"></i> Adicionar anotação
              </button>

              <button class="btn btn-danger w-100 mt-auto" id="excluirMoto">
                <i class="bi bi-trash"></i> Excluir Moto
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal Galeria -->
<div class="modal fade" id="galeriaModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Galeria do Serviço</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="file" class="form-control mb-3" id="uploadFotos" multiple accept="image/*">
        <div class="row g-3" id="galeriaContainer"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Foto Tela Cheia -->
<div class="modal fade" id="fotoModal">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">
      <div class="modal-body d-flex justify-content-center align-items-center">
        <img id="fotoGrande" class="img-fluid">
      </div>
      <button class="btn btn-light position-fixed top-0 end-0 m-3" id="fecharFoto">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>
</div>

<script>
const cardsContainer = document.getElementById("cardsContainer");
let motoGaleriaAtual = null;

// ================== SALVAR SERVIÇO ==================
document.getElementById("salvarServico").onclick = () => {
  const nomeMoto = document.getElementById("motoNome").value.trim();
  const placaMoto = document.getElementById("placa").value.trim();
  const cliente = document.getElementById("clienteNome").value.trim();
  const contato = document.getElementById("clienteContato").value.trim();
  const status = document.getElementById("status").value;
  const imagem = document.getElementById("imagem").value || "./img/default.jpg";

  if (!nomeMoto || !placaMoto || !cliente) return alert("Preencha tudo");

  const statusTexto = status === "andamento" ? "Em andamento" : "Serviço concluído";
  const statusCor = status === "andamento" ? "text-danger" : "text-success";

  const col = document.createElement("div");
  col.className = "col";
  col.innerHTML = `
    <div class="card">
      <img src="${imagem}" class="card-img-top">
      <div class="card-body">
        <h5 class="card-title">${nomeMoto}</h5>
        <p class="card-text"><strong>Placa:</strong> ${placaMoto}</p>
        <p class="fs-6 fw-bold ${statusCor}">${statusTexto}</p>
        <button class="btn btn-outline-warning btn-detalhes">Detalhes</button>
        <button class="btn btn-outline-secondary btn-galeria">Galeria</button>
      </div>
    </div>
  `;

  const motoInfo = {
    nome: nomeMoto,
    placa: placaMoto,
    clienteNome: cliente,
    clienteContato: contato,
    statusTexto,
    imagem,
    historico: [],
    galeria: [],
    oleo: null
  };

  col.querySelector(".card")._motoInfo = motoInfo;
  adicionarEventoDetalhes(col, motoInfo);
  cardsContainer.appendChild(col);

  bootstrap.Modal.getInstance(document.getElementById("novoServicoModal")).hide();
};

// ================== DETALHES MOTO ==================
function adicionarEventoDetalhes(col, motoInfo) {
  const btnDetalhes = col.querySelector(".btn-detalhes");
  const btnGaleria = col.querySelector(".btn-galeria");

  btnDetalhes.onclick = () => {
    const detalhesModalEl = document.getElementById("detalhesModal");
    const detalhesTitulo = document.getElementById("detalhesTitulo");
    const detalhesPlaca = document.getElementById("detalhesPlaca");
    const detalhesCliente = document.getElementById("detalhesCliente");
    const detalhesContato = document.getElementById("detalhesContato");
    const detalhesStatusSelect = document.getElementById("detalhesStatusSelect");
    const adicionarNota = document.getElementById("adicionarNota");
    const tituloNota = document.getElementById("tituloNota");
    const textoNota = document.getElementById("textoNota");
    const ultimaAtualizacao = document.getElementById("ultimaAtualizacao");
    const formTrocaOleo = document.getElementById("formTrocaOleo");
    const alertaTrocaOleo = document.getElementById("alertaTrocaOleo");

    detalhesTitulo.textContent = motoInfo.nome;
    detalhesPlaca.innerHTML = "<b>Placa:</b> " + motoInfo.placa;
    detalhesCliente.innerHTML = "<b>Cliente:</b> " + motoInfo.clienteNome;
    detalhesContato.innerHTML = "<b>Contato:</b> " + (motoInfo.clienteContato || "-");
    detalhesStatusSelect.value = motoInfo.statusTexto === "Em andamento" ? "andamento" : "concluido";

    formTrocaOleo.classList.add("d-none");
    alertaTrocaOleo.textContent = "";
    // ================== TROCA DE ÓLEO ==================
btnTrocaOleo.onclick = () => {
  formTrocaOleo.classList.toggle("d-none");
};

salvarTrocaOleo.onclick = () => {
  const tipo = tipoOleo.value.trim();
  const kmAtualValor = parseInt(kmAtual.value);
  const kmProx = parseInt(kmProximaTroca.value);
  const mesesProx = parseInt(mesesProximaTroca.value);

  if (!tipo || isNaN(kmAtualValor) || isNaN(kmProx)) {
    alertaTrocaOleo.textContent = "Preencha corretamente os campos obrigatórios.";
    return;
  }

  const agora = new Date();

  motoInfo.oleo = {
    tipo,
    kmAtual: kmAtualValor,
    kmProx,
    mesesProx: mesesProx || null,
    data: agora
  };

  alertaTrocaOleo.textContent = "Troca de óleo registrada com sucesso.";
  alertaTrocaOleo.classList.remove("text-danger");
  alertaTrocaOleo.classList.add("text-success");

  formTrocaOleo.classList.add("d-none");

  motoInfo.historico.push({
    titulo: "Troca de óleo",
    texto: `Óleo ${tipo} trocado em ${kmAtualValor} km. Próxima troca em ${kmProx} km.`,
    dataHora: agora.toLocaleString("pt-BR"),
    timestamp: agora.getTime()
  });

  renderizarHistorico(motoInfo);
};


    new bootstrap.Modal(detalhesModalEl).show();
  };

  btnGaleria.onclick = () => {
    motoGaleriaAtual = motoInfo;
    abrirGaleria(motoInfo);
  };
}

// ================== GALERIA ==================
function abrirGaleria(motoInfo) {
  const galeriaContainer = document.getElementById("galeriaContainer");
  galeriaContainer.innerHTML = "";

  if (motoInfo.galeria.length === 0) {
    galeriaContainer.innerHTML = "<p class='text-muted'>Nenhuma foto cadastrada.</p>";
  } else {
    motoInfo.galeria.forEach((url, i) => {
      const col = document.createElement("div");
      col.className = "col-md-3 mb-2";
      col.innerHTML = `<img src="${url}" class="img-fluid rounded shadow-sm" style="cursor:pointer;" data-index="${i}">`;
      galeriaContainer.appendChild(col);
    });

    galeriaContainer.querySelectorAll("img").forEach(img => {
      img.onclick = () => {
        const fotoModal = new bootstrap.Modal(document.getElementById("fotoModal"));
        document.getElementById("fotoGrande").src = img.src;
        fotoModal.show();
      };
    });
  }

  new bootstrap.Modal(document.getElementById("galeriaModal")).show();
}

// ================== UPLOAD DE FOTOS ==================
document.getElementById("uploadFotos").addEventListener("change", (event) => {
  if (!motoGaleriaAtual) return;
  const arquivos = Array.from(event.target.files);
  arquivos.forEach(file => motoGaleriaAtual.galeria.push(URL.createObjectURL(file)));
  abrirGaleria(motoGaleriaAtual);
  event.target.value = "";
});

document.getElementById("fecharFoto").addEventListener("click", () => {
  const fotoModalEl = document.getElementById("fotoModal");
  const fotoModal = bootstrap.Modal.getInstance(fotoModalEl);
  fotoModal.hide();
  document.querySelectorAll(".modal-backdrop").forEach(b => b.remove());
  document.body.classList.remove("modal-open");
  document.body.style.overflow = "auto";
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
