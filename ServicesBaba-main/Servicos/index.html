<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Babalu Motos Services</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="./style.css">
</head>

<body>

<nav class="navbar bg-body-tertiary">
<div class="container-fluid">

<form class="d-flex">
<input class="form-control me-2" type="search" placeholder="Digite o Nome/Placa" id="searchInput"/>

</form>

<button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#novoServicoModal">
<i class="bi bi-plus-circle"></i> Adicionar Novo
</button>

</div>
<!-- Aba de alertas -->
<div class="dropdown d-inline">
  <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btnAlertas">
    ‚ö† Troca de √ìleo <span class="badge bg-danger" id="contagemAlertas">0</span>
  </button>
  <ul class="dropdown-menu" id="listaAlertas" style="width: 350px; max-height: 400px; overflow-y:auto;">
    <!-- Alertas ser√£o inseridos aqui -->
  </ul>
</div>

</div>
</nav>

<!-- Cards -->
  <div class="container">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 justify-content-center" id="cardsContainer">
      
      
    </div>
  </div>
<!-- Modal novo servi√ßo -->
<div class="modal fade" id="novoServicoModal">
<div class="modal-dialog">
<div class="modal-content">

<div class="modal-header">
<h5>Novo Servi√ßo</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<input class="form-control mb-2" placeholder="Nome da Moto" id="motoNome">
<input class="form-control mb-2" placeholder="Placa" id="placa">
<input class="form-control mb-2" placeholder="Cliente" id="clienteNome">
<input class="form-control mb-2" placeholder="Contato" id="clienteContato">

<select class="form-select mb-2" id="status">
<option value="andamento">Em andamento</option>
<option value="concluido">Servi√ßo conclu√≠do</option>
</select>

<input class="form-control" placeholder="URL imagem" id="imagem">
</div>

<div class="modal-footer">
<button class="btn btn-success" id="salvarServico">Salvar</button>
</div>

</div>
</div>
</div>

<!-- Modal detalhes -->
<div class="modal fade" id="detalhesModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="detalhesTitulo"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-4">

          <!-- BLOCO ESQUERDO: DADOS DA MOTO/CLIENTE -->
          <div class="col-md-5">
            <div class="card p-4 shadow-sm w-100" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Informa√ß√µes da Moto</h5>
              <p id="detalhesPlaca"></p>
              <p id="detalhesCliente"></p>
              <p id="detalhesContato"></p>

              <select class="form-select mt-3" id="detalhesStatusSelect">
                <option value="andamento">Em andamento</option>
                <option value="concluido">Servi√ßo conclu√≠do</option>
              </select>
              <!-- Bot√£o Troca de √ìleo -->
<button class="btn btn-outline-success w-100 mb-2" type="button" id="btnTrocaOleo">
  <i class="bi bi-droplet"></i> Troca de √ìleo
</button>

<!-- Formul√°rio de Troca de √ìleo (inicialmente escondido) -->
<div class="card p-3 mb-2 d-none" id="formTrocaOleo">
  <h6>Registrar Troca de √ìleo</h6>

  <input class="form-control mb-2" id="tipoOleo" placeholder="Tipo de √ìleo">
  <input type="number" class="form-control mb-2" id="kmAtual" placeholder="Quilometragem atual">
  <input type="number" class="form-control mb-2" id="kmProximaTroca" placeholder="Pr√≥xima troca (km)">
  <input type="number" class="form-control mb-2" id="mesesProximaTroca" placeholder="Pr√≥xima troca (meses)">

  <button class="btn btn-success w-100" id="salvarTrocaOleo">Salvar Troca</button>

  <small class="text-danger mt-2 d-block" id="alertaTrocaOleo"></small>
</div>
            </div>
          </div>

          <!-- BLOCO DIREITO: HIST√ìRICO E ANOTA√á√ïES -->
          <div class="col-md-7">
            <div class="card p-4 shadow-sm w-100 d-flex flex-column" style="box-sizing: border-box;">
              <h5 class="fw-bold mb-3">Hist√≥rico e Anota√ß√µes</h5>

              <!-- Hist√≥rico com scroll apenas nele -->
              <div class="accordion mb-3 flex-grow-1 overflow-auto" id="historicoAccordion" style="max-height: 60vh;"></div>

              <small id="ultimaAtualizacao" class="text-muted d-block mb-3"></small>

              <input class="form-control mb-2" id="tituloNota" placeholder="T√≠tulo da anota√ß√£o">
              <textarea class="form-control mb-2" id="textoNota" rows="3" placeholder="Descri√ß√£o do servi√ßo..."></textarea>

              <button class="btn btn-outline-primary w-100 mb-2" id="adicionarNota">
                <i class="bi bi-plus-lg"></i> Adicionar anota√ß√£o
              </button>


              <button class="btn btn-danger w-100 mt-auto" id="excluirMoto">
                <i class="bi bi-trash"></i> Excluir Moto
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>



<!-- Modal Galeria -->
<div class="modal fade" id="galeriaModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Galeria do Servi√ßo</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="file" class="form-control mb-3" id="uploadFotos" multiple accept="image/*">

        <div class="row g-3" id="galeriaContainer"></div>

      </div>
    </div>
  </div>
</div>
<!-- Modal Foto Tela Cheia -->
 <div class="modal fade" id="fotoModal">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">

      <div class="modal-body d-flex justify-content-center align-items-center">
        <img id="fotoGrande" class="img-fluid">
      </div>

      <button class="btn btn-light position-fixed top-0 end-0 m-3" data-bs-dismiss="modal">
        <i class="bi bi-x-lg"></i>
      </button>

    </div>
  </div>
</div>


<script>
<<<<<<< HEAD
 let motoSelecionada = null;

const btnTrocaOleo = document.getElementById("btnTrocaOleo");
const formTrocaOleo = document.getElementById("formTrocaOleo");
const alertaTrocaOleo = document.getElementById("alertaTrocaOleo");
if (btnTrocaOleo && formTrocaOleo) {
  btnTrocaOleo.onclick = () => {
    formTrocaOleo.classList.toggle("d-none");
  };
}
=======
  let motoSelecionada = null;
>>>>>>> d9d999e37223484b5530a2a56e6713ee3fba3f08
document.getElementById("salvarServico").onclick = () => {

const nomeMoto = motoNome.value.trim();
const placaMoto = placa.value.trim();
const cliente = clienteNome.value.trim();
const contato = clienteContato.value.trim();
const status = document.getElementById("status").value;
const imagem = document.getElementById("imagem").value || "./img/default.jpg";

if(!nomeMoto || !placaMoto || !cliente) return alert("Preencha tudo");

const statusTexto = status === "andamento" ? "Em andamento" : "Servi√ßo conclu√≠do";
const statusCor = status === "andamento" ? "text-danger" : "text-success";

const col = document.createElement("div");
col.className = "col";

col.innerHTML = `
<div class="card">
<img src="${imagem}" class="card-img-top">
<div class="card-body">
<h5 class="card-title">${nomeMoto}</h5>
<p class="card-text"><strong>Placa:</strong> ${placaMoto}</p>
<p class="fs-6 fw-bold ${statusCor}">${statusTexto}</p>
<button class="btn btn-outline-warning">Detalhes</button>
<button class="btn btn-outline-secondary">Galeria</button>
</div>
</div>
`;

const motoInfo = {
nome: nomeMoto,
placa: placaMoto,
clienteNome: cliente,
clienteContato: contato,
statusTexto,
imagem,
historico: [],
galeria: [],
contador: 0
};
motoInfo.card = col;
col.motoInfo = motoInfo;


adicionarEventoDetalhes(col, motoInfo);
cardsContainer.appendChild(col);

bootstrap.Modal.getInstance(novoServicoModal).hide();
};

// üîπ LIMPAR MODAL AO ABRIR
novoServicoModal.addEventListener("show.bs.modal", () => {
motoNome.value = "";
placa.value = "";
clienteNome.value = "";
clienteContato.value = "";
imagem.value = "";
status.value = "andamento";
});

// üîπ RENDERIZA HIST√ìRICO ORDENADO
function renderizarHistorico(motoInfo){
historicoAccordion.innerHTML = "";

motoInfo.historico
.sort((a,b) => b.timestamp - a.timestamp)
.forEach(nota => adicionarNotaUI(nota));
}

function adicionarEventoDetalhes(card, motoInfo){

  // üîò pega os dois bot√µes do card
  const botoes = card.querySelectorAll("button");
  const btnDetalhes = botoes[0];
  const btnGaleria  = botoes[1];

  // üîç BOT√ÉO DETALHES
  btnDetalhes.onclick = () => {
    motoSelecionada = motoInfo;
    carregarFormTrocaOleo(motoInfo);
    formTrocaOleo.classList.add("d-none");

    // Dados
    detalhesTitulo.textContent = motoInfo.nome;
    detalhesPlaca.innerHTML = "<b>Placa:</b> " + motoInfo.placa;
    detalhesCliente.innerHTML = "<b>Cliente:</b> " + motoInfo.clienteNome;
    detalhesContato.innerHTML = "<b>Contato:</b> " + (motoInfo.clienteContato || "-");

    // Select
    detalhesStatusSelect.value =
      motoInfo.statusTexto === "Em andamento" ? "andamento" : "concluido";

    // Hist√≥rico
    renderizarHistorico(motoInfo);

    // üî• STATUS AUTOM√ÅTICO
    detalhesStatusSelect.onchange = () => {

      const agora = new Date();
      const timestamp = agora.getTime();
      const novoStatus = detalhesStatusSelect.value;

      const statusTexto =
        novoStatus === "andamento"
          ? "Em andamento"
          : "Servi√ßo conclu√≠do";

      const statusCor =
        novoStatus === "andamento"
          ? "text-danger"
          : "text-success";

      motoInfo.statusTexto = statusTexto;

      // Card
      const statusElemento =
        card.querySelector(".card-body p.fw-bold");

      statusElemento.textContent = statusTexto;
      statusElemento.classList.remove("text-danger","text-success");
      statusElemento.classList.add(statusCor);

      // Move card
      if(novoStatus === "concluido"){
        cardsContainer.appendChild(card);
      }else{
        cardsContainer.prepend(card);
      }

      // Data
      const dataHora =
        agora.toLocaleDateString("pt-BR")+" "+
        agora.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

      ultimaAtualizacao.textContent =
        "√öltima atualiza√ß√£o: " + dataHora;

      // Hist√≥rico
      motoInfo.historico.push({
        titulo: "Status alterado",
        texto: "Status alterado para: " + statusTexto,
        dataHora,
        timestamp
      });

      renderizarHistorico(motoInfo);
    };

    // üìù ANOTA√á√ÉO
    adicionarNota.onclick = () => {

      const titulo = tituloNota.value.trim();
      const texto = textoNota.value.trim();
      if(!titulo || !texto) return;

      const agora = new Date();
      const timestamp = agora.getTime();

      const dataHora =
        agora.toLocaleDateString("pt-BR")+" "+
        agora.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

      motoInfo.historico.push({
        titulo,
        texto,
        dataHora,
        timestamp
      });

      renderizarHistorico(motoInfo);

      ultimaAtualizacao.textContent =
        "√öltima atualiza√ß√£o: " + dataHora;

      tituloNota.value = "";
      textoNota.value = "";
    };
const btnExcluir = document.getElementById("excluirMoto");
btnExcluir.onclick = () => {
  if(confirm(`Deseja realmente excluir a moto "${motoInfo.nome}"?`)) {
    card.remove();
    bootstrap.Modal.getInstance(detalhesModal).hide();
  }
};
    new bootstrap.Modal(detalhesModal).show();
  };

  // üì∑ BOT√ÉO GALERIA
  btnGaleria.onclick = () => {
    abrirGaleria(motoInfo);
  };
}



function adicionarNotaUI(nota){

  const id = "nota_" + nota.timestamp;

  const item = document.createElement("div");
  item.className = "accordion-item";

  item.innerHTML = `
  <h2 class="accordion-header">
    <button class="accordion-button"
      data-bs-toggle="collapse"
      data-bs-target="#${id}">
      ${nota.titulo}
      <small class="ms-2 text-muted"><strong>(${nota.dataHora})</strong></small>
    </button>
  </h2>

  <div id="${id}" class="accordion-collapse collapse">
    <div class="accordion-body">

      <div class="nota-texto" style="white-space:pre-wrap; cursor:text">
        ${nota.texto}
      </div>

      <textarea class="form-control d-none nota-edicao" rows="4">${nota.texto}</textarea>

      <button class="btn btn-sm btn-success mt-2 d-none salvar-nota">
        <i class="bi bi-check-lg"></i> Salvar
      </button>

    </div>
  </div>
  `;

  historicoAccordion.appendChild(item);

  const divTexto = item.querySelector(".nota-texto");
  const textarea = item.querySelector(".nota-edicao");
  const btnSalvar = item.querySelector(".salvar-nota");

  let textoOriginal = nota.texto;

  /* üëâ CLICOU NO TEXTO ‚Üí EDITAR */
  divTexto.onclick = () => {
    divTexto.classList.add("d-none");
    textarea.classList.remove("d-none");
    textarea.focus();
  };

  /* üî• MOSTRAR SALVAR S√ì SE ALTERAR */
  textarea.addEventListener("input", () => {
    if (textarea.value.trim() !== textoOriginal.trim()) {
      btnSalvar.classList.remove("d-none");
    } else {
      btnSalvar.classList.add("d-none");
    }
  });

  /* üíæ SALVAR */
  btnSalvar.onclick = () => {
  const novoTexto = textarea.value.trim();
  if (!novoTexto) return;

  const agora = new Date();

  nota.texto = novoTexto;
  nota.dataHora =
    agora.toLocaleDateString("pt-BR") + " " +
    agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });

  nota.timestamp = agora.getTime();

  // atualiza texto vis√≠vel
  divTexto.textContent = novoTexto;

  // sai do modo edi√ß√£o
  textarea.classList.add("d-none");
  divTexto.classList.remove("d-none");

  // üî• ESCONDE O BOT√ÉO SALVAR
  btnSalvar.classList.add("d-none");

  // atualiza refer√™ncia do texto original
  textoOriginal = novoTexto;
};

}

function abrirGaleria(motoInfo){
  const galeriaContainer = document.getElementById("galeriaContainer");
  const uploadFotos = document.getElementById("uploadFotos");

  galeriaContainer.innerHTML = "";

  motoInfo.galeria.forEach(src => criarThumb(src));

  uploadFotos.onchange = () => {
    [...uploadFotos.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        motoInfo.galeria.push(e.target.result);
        criarThumb(e.target.result);
      };
      reader.readAsDataURL(file);
    });
    uploadFotos.value = "";
  };

  new bootstrap.Modal(galeriaModal).show();

  function criarThumb(src){
    const col = document.createElement("div");
    col.className = "col-6 col-md-3";

    col.innerHTML = `
      <img src="${src}" class="img-fluid rounded shadow-sm" style="cursor:pointer">
    `;

    col.querySelector("img").onclick = () => {
      document.getElementById("fotoGrande").src = src;
      new bootstrap.Modal(fotoModal).show();
    };

    galeriaContainer.appendChild(col);
  }
}
const searchInput = document.getElementById("searchInput");
const btnPesquisar = document.getElementById("btnPesquisar");

function filtrarCards() {
  const termo = searchInput.value.toLowerCase();
  const cards = cardsContainer.querySelectorAll(".card");

  cards.forEach(card => {
    const titulo = card.querySelector(".card-title").textContent.toLowerCase();
    const placa = card.querySelector(".card-text").textContent.toLowerCase();
    if (titulo.includes(termo) || placa.includes(termo)) {
      card.parentElement.style.display = ""; // mostra card
    } else {
      card.parentElement.style.display = "none"; // esconde card
    }
  });
}

document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.key.toLowerCase() === "f") {
    e.preventDefault(); // previne a busca do navegador
    searchInput.focus();
    searchInput.select();
  }
});

// üîπ Filtra enquanto digita (opcional)
searchInput.addEventListener("input", filtrarCards);

// Toggle formul√°rio de troca de √≥leo


btnTrocaOleo.onclick = () => {
  formTrocaOleo.classList.toggle("d-none");
};

// Salvar troca de √≥leo
document.getElementById("salvarTrocaOleo").onclick = () => {
  if (!motoSelecionada) {
    alert("Nenhuma moto selecionada.");
    return;
  }

  const tipoOleo = document.getElementById("tipoOleo").value.trim();
  const kmAtual = parseInt(document.getElementById("kmAtual").value);
  const kmProx = parseInt(document.getElementById("kmProximaTroca").value);
  const mesesProx = parseInt(document.getElementById("mesesProximaTroca").value);

  if(!tipoOleo && !kmAtual && !kmProx && !mesesProx){
    alert("Preencha ao menos algum campo.");
    return;
  }

  const agora = new Date();
  let dataProx = null;

  if(mesesProx){
    dataProx = new Date();
    dataProx.setMonth(agora.getMonth() + mesesProx);
  }

  motoSelecionada.oleo = {
    tipo: tipoOleo,
    kmAtual: kmAtual || 0,
    kmProx: kmProx || 0,
    mesesProx: mesesProx || 0,
    dataProx: dataProx ? dataProx.getTime() : null
  };

  alertaTrocaOleo.textContent = "Troca registrada com sucesso.";
  formTrocaOleo.classList.add("d-none");
  verificarAlertasTrocaOleo();

};

function verificarAlertasTrocaOleo() {
  const lista = document.getElementById("listaAlertas");
  const badge = document.getElementById("contagemAlertas");

  lista.innerHTML = "";
  let totalAlertas = 0;
  const agora = new Date().getTime();

  document.querySelectorAll("#cardsContainer .col").forEach(col => {
    const card = col.querySelector(".card");

// pega a motoInfo vinculada ao card
const motoInfo = col.motoInfo;
if (!motoInfo || !motoInfo.oleo) return;

const titulo = card.querySelector(".card-title").textContent;
const placa = motoInfo.placa;

    if (!motoInfo || !motoInfo.oleo) return;

    const oleo = motoInfo.oleo;
    let mensagens = [];

    if (oleo.kmProx && oleo.kmAtual >= oleo.kmProx) {
      mensagens.push("Quilometragem atingida");
    }

    if (oleo.dataProx && agora >= oleo.dataProx) {
      mensagens.push("Prazo de meses vencido");
    }

    if (mensagens.length) {
      totalAlertas++;

      const li = document.createElement("li");
li.className = "dropdown-item text-danger";
li.style.cursor = "pointer";

li.innerHTML = `
  <strong>${titulo}</strong>
  <span class="text-muted"> - ${placa}</span><br>
  <small>${mensagens.join(" / ")}</small>
`;

li.onclick = () => {
  // fecha o dropdown
  document.getElementById("btnAlertas").click();

  // define moto selecionada
  motoSelecionada = motoInfo;

  // abre detalhes simulando clique no bot√£o do card
  const btnDetalhes = motoInfo.card.querySelector("button");
  btnDetalhes.click();
};

lista.appendChild(li);
    }
  });

  badge.textContent = totalAlertas;
}
setInterval(verificarAlertasTrocaOleo, 60000); // a cada 1 minuto

verificarAlertasTrocaOleo();
function carregarFormTrocaOleo(motoInfo){
  const tipoOleo = document.getElementById("tipoOleo");
  const kmAtual = document.getElementById("kmAtual");
  const kmProx = document.getElementById("kmProximaTroca");
  const mesesProx = document.getElementById("mesesProximaTroca");
  const alerta = document.getElementById("alertaTrocaOleo");

  alerta.textContent = "";

  if (motoInfo.oleo) {
    tipoOleo.value = motoInfo.oleo.tipo || "";
    kmAtual.value = motoInfo.oleo.kmAtual || "";
    kmProx.value = motoInfo.oleo.kmProx || "";
    mesesProx.value = motoInfo.oleo.mesesProx || "";
  } else {
    tipoOleo.value = "";
    kmAtual.value = "";
    kmProx.value = "";
    mesesProx.value = "";
  }
}


</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>